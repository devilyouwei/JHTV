<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <title>webview</title>
    <link rel="stylesheet" type="text/css" href="../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../css/style.css" />
    <link rel="stylesheet" type="text/css" href="../css/aui.css" />
    <link rel="stylesheet" type="text/css" href="../css/aui-flex.css" />
    <style>
        body {
            background: #fff;
        }

        header.aui-bar {
            color: #000!important;
        }

        .aui-bar .aui-iconfont {
            color: #000!important;
            font-weight: bold;
        }

        .aui-bar .aui-title {
            color: #000!important;
        }

        .flex-con {
            overflow: auto;
            background-color: #fff;
            height: 100%;
        }
    </style>
</head>

<body>
    <div id="wrap">
        <header class="aui-bar aui-bar-nav aui-bar-light">
            <div class="aui-pull-left aui-btn" style="display:none;" id="back">
                <span class="aui-iconfont aui-icon-left" tapmode onClick="historyBack()"></span>
            </div>
            <div class="aui-title"></div>
            <div class="aui-pull-right aui-btn" id="close">
                <span class="aui-iconfont aui-icon-close" tapmode onClick="closeWin()"></span>
            </div>
        </header>
        <div id="main" class="flex-con"></div>
    </div>
</body>
<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript" src="../script/app.js"></script>
<script type="text/javascript">
    apiready = function() {
        $api.fixStatusBar($api.dom('header'));
        $api.dom('header .aui-title').innerHTML = api.pageParam.navTitle + '&nbsp;&nbsp;<span class="aui-iconfont aui-icon-refresh" tapmode onClick="refresh()"></span>';
        if ($.getOS() == 'ios') $api.dom('#back').style.display = 'block'; // ios显示返回按钮
        initWebviewFrame();
    }

    // frame返回上一页
    function historyBack() {
        $.remove('web_title');
        api.historyBack({
            frameName: 'webviewFrame'
        }, function(ret, err) {
            if (!ret.status) closeWin();
        });
    }
    // 刷新frame
    function refresh() {
        $.remove('web_title');
        // x5引擎
        api.execScript({
            frameName: 'webviewFrame',
            script: 'location.reload();'
        });
    }

    //初始化frame
    function initWebviewFrame() {
        // 打开webview frame
        api.openFrame({
            name: 'webviewFrame',
            url: api.pageParam.url,
            rect: {
                x: 0,
                y: $api.dom('header').offsetHeight,
                w: api.winWidth,
                h: $api.dom('#main').offsetHeight
            },
            progress: {
                type: 'page',
                color: '#ff5e3e'
            }
        });
        // 监听frame变化
        api.setFrameClient({
            frameName: 'webviewFrame'
        }, function(res, err) {
            $.closePlayer();
            $.log(res);
            if (res.progress) $.set('web_progress', res.progress);
            if (res.url) $.set('web_url', res.url);
            if ($.get('web_progress') == 100) execJs();
        });
        // 监听内部网页事件
        api.addEventListener({
            name: 'hackVideo'
        }, function(res, err) {
            if (res && res.value) hackVideo(res.value.href, res.value.title);
        });
        // 返回键frame返回上一页
        api.addEventListener({
            name: 'keyback'
        }, historyBack)
    }

    // 关闭win
    function closeWin() {
        $.remove('web_url')
        $.remove('web_title')
        api.closeWin();
    }

    // 运行特殊的js
    function execJs() {
        var url = $.get('web_url');
        var js =
            `
        var video = document.getElementsByTagName('video');
        var tx = document.getElementsByClassName('site_player');
        if((video && video[0]) || (tx && tx[0])){
          api.sendEvent({
              name: 'hackVideo',
              extra: {
                  href: location.href,
                  title: document.title
              }
          });
        }
        `
        api.execScript({
            frameName: 'webviewFrame',
            script: js
        });
    }

    function hackVideo(url, title) {
        var webTitle = $.get('web_title');
        if (webTitle == title) return;
        $.set('web_title', title);
        $.log('破解视频：' + title);
        if (url && title) {
            $.load(true, '超级会员登陆中');
            $.post('My/getVideoInfo', { //获取sign
                video_url: url,
                video_title: title
            }, function(res) {
                if (res.status == 1) { // 获取视频源
                    var user = $.getUserInfo();
                    var playUrl = `${API}/My/video?user_id=${user.user_id}&token=${user.token}&sign=${res.results.sign}`;
                    $.openPlayer(playUrl);
                } else {
                    $.toast(res.msg)
                    $.log(url)
                    $.openWebview(title, url, true);
                }
            });
        }
    }
</script>

</html>
